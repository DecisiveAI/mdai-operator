# Managing Ingress for the MDAI Cluster's OTel Collector 

If the Cluster is deployed in public cloud environment, and telemetry sources reside outside of that cluster, 
you might want to expose your OpenTelemetry Collector outside the Kubernetes cluster. MDAI Ingress controller (a part of MDAI operator)
will help you to automate this process.

## How it works

MDAI Ingress controller watches for linked bundles Otelcol-MdaiIngress CRs and dynamically, based on the current OTel collector configuration creates 
Service and Ingress resources, needed for provisioning AWS LoadBalancer resources (AWS Load Balancer Controller is responsible for that).

One Application Load Balancer (ALB) will be created if there is 1 or more gPRC receiver endpoints in the collector config.

One Network Load Balancer (NLB) will be created if there is 1 or more non-gRPC (HTTP, TCP, UDP) receiver endpoints in the collector config.

## Prerequisites

1. Supported Public CLoud: AWS
2. AWS EKS cluster
3. Installed [AWS Load Balancer Controller](https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html)
4. Access to your internal or public DNS service to create CNAME records for your Load Balancers endpoints
5. SSL certificate(s), issued for your CNAME hosts, and stored in [AWS certificate manager](https://aws.amazon.com/certificate-manager/)

## Configuration

### Disable ingress management in the original OTel Collector Custom Resource.

To achieve that do not add `spec.ingress` filed in the Otelcol CR spec.


###  Configure MDAI Otel Collector Ingress with MdaiIngress Custom Resource.

Create Custom Resource `MdaiIngress` using [this sample](../config/samples/hub_v1_mdaiingress.yaml).
Your CR name and namespace should be equal to Opentelemetrycollector name and namespace respectively:

```yaml
apiVersion: hub.mydecisive.ai/v1
kind: MdaiIngress
metadata:
  name: gateway # <<< 
  namespace: mdai  # <<<
```

```yaml
apiVersion: opentelemetry.io/vbeta1
kind: OpenTelemetryCollector
metadata:
  name: gateway # <<<
  namespace: mdai # <<<
```

`spec.cloudType` sets the public cloud type. Supported values: `aws`
```yaml
spec:
  cloudType: aws
```

`spec.collectorEndpoints` sets a mapping between receivers names and corresponding DNS names. This is for gRPC receivers only
Say, we have the following Otel collector config:
```yaml
    receivers:
      otlp:
        protocols:
          grpc:
      jaeger:
        protocols:
          grpc:
    exporters:
      debug: {}
    processors:
      batch:
    service:
      pipelines:
        logs:
          receivers:
            - otlp
            - jaeger
          processors:
            - batch
          exporters:
            - debug
```
In order to provide routing to these 2 gRPC receivers with just 1 Application Load Balancer, you need to set the following mapping:

```yaml
spec:
  collectorEndpoints:
    otlp: otlp.mdai.io
    jaeger: jaeger.mdai.io
```

Section `spec.annotations` contains annotations that will go to Ingress resource, generated by the MDAI Ingress controller, and are used by
AWS Load Balancer Controller for ALB provisioning.
```yaml
spec:
  annotations:
    alb.ingress.kubernetes.io/certificate-arn: 'arn:aws:acm:${AWS_REGION}:${AWS_ACCOUNT}:certificate/${AWS_CERT_ARN}' # <- certificate arn
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]' # <- ALB Listener ports
    alb.ingress.kubernetes.io/load-balancer-name: mdai-grpc-endpoint # <- (optional) name for the ALB
    alb.ingress.kubernetes.io/backend-protocol-version: GRPC # <- backend protocol (DONT CHANGE!)
    alb.ingress.kubernetes.io/scheme: internal #  <- can be 'internal' or 'internet-facing'
    alb.ingress.kubernetes.io/target-type: ip # <- target type: can be 'instance' or 'ip' 
    kubernetes.io/ingress.class: alb # <- ingress class (DONT CHANGE!)
```
More about [AWS Load Balancer Ingress Annotations](https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/)


Mandatory blocks `spec.grpcService` and `spec.nonGrpcService` provide specification for Service resources.

`grpcService` block provides a type for Service `${COLLECTOR_NAME}-collector-grpc`, created by MDAI Ingress controller. 
It contains all gRPC receivers ports from the collector configuration (if any). Based on this Service configuration, MDAI Ingress Controller builds Ingress resources,
which in turn is used by AWS LB Controller to provision an ALB.
```yaml
  grpcService:
    type: NodePort # <- Service type (DONT CHANGE)
```

`nonGrpcService` block provides a type and annotations for Service `${COLLECTOR_NAME}-collector-non-grpc`, created by MDAI Ingress controller.
It contains all non-gRPC receivers ports from the collector configuration (if any). Based on this Service configuration, AWS Load Balancer Controller
provisions an NLB
```yaml
  nonGrpcService:
    type: LoadBalancer # <- Service type (DONT CHANGE)
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-name: mdai-non-grpc-endpoint # <- (optional) name for the NLB 
      service.beta.kubernetes.io/aws-load-balancer-type: external #  DONT CHANGE, for more info: https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/service/annotations/#lb-type
      service.beta.kubernetes.io/aws-load-balancer-backend-protocol: http # <- backend protocol (DONT CHANGE!)
      service.beta.kubernetes.io/aws-load-balancer-scheme: internal  # <- can be 'internal' or 'internet-facing'
      service.beta.kubernetes.io/aws-load-balancer-ssl-cert: 'arn:aws:acm:${AWS_REGION}:${AWS_ACCOUNT}:certificate/${AWS_CERT_ARN}'  # <- certificate arn
```
More about [AWS Load Balancer Service Annotations](https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/service/annotations/)
